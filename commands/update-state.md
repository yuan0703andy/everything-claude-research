---
name: update-state
description: 更新 STATE.md，記錄當前研究狀態
---

# /update-state

更新專案的 STATE.md 檔案，記錄研究進度和狀態。

## 目的

維護跨 session 的狀態連續性：
- 記錄本次 session 完成的工作
- 更新假說排名
- 記錄關鍵決定
- 列出下次應做的事
- 提醒重要 context

## 何時使用

**建議時機**：
- ✅ Session 結束前（最常用）
- ✅ 完成重要里程碑後
- ✅ 做出關鍵決定後
- ✅ 假說排名變動後
- ✅ Phase 轉換時

**不建議時機**：
- ❌ 工作進行到一半
- ❌ 還在思考問題時
- ❌ 沒有實質進展時

## 流程

### 1. 讀取當前狀態

Lab Manager 讀取：
```
- STATE.md（當前狀態）
- hypotheses/HYPOTHESES.md（假說排名）
- .planning/phases/（最近的 phase 記錄）
```

### 2. 收集本次 Session 資訊

Lab Manager 詢問或自動檢測：

**完成的工作**：
```
Q: 本次 session 完成了什麼？
A: [用戶描述，或從工具調用歷史推斷]

例如：
- 完成了 H-003 的 Experimentalist 審查
- 執行了主要迴歸分析
- 更新了文獻回顧
- 修正了數據清理腳本
```

**關鍵決定**：
```
Q: 是否做出了重要決定？
A: [用戶描述]

例如：
- 決定使用 diff-in-diff 而非 RDD
- 決定排除 2008 年前的數據
- 決定暫緩 H-002（數據不可得）
```

**假說排名變化**：
```
檢查是否有：
- 新增假說
- 假說狀態變化（草稿 → 審查中 → 已驗證）
- Elo 分數更新
```

**待解決問題**：
```
Q: 遇到了哪些需要解決的問題？
A: [用戶描述]

例如：
- H-003 樣本量是否足夠？需要 power analysis
- 應該用 cluster SE 還是 robust SE？
```

**下次應做的事**：
```
Q: 下次 session 應該做什麼？
A: [用戶描述或從計畫推斷]

例如：
1. 完成 H-003 的 Methodologist 審查
2. 更新 Elo 排名
3. 開始 H-007 的深度審查
```

### 3. 檢查假說狀態

自動讀取 `hypotheses/HYPOTHESES.md`：

```markdown
## 當前假說排名

| Rank | Δ | ID | Elo | 標題 | 狀態 | 上次更新 |
|------|---|-----|-----|------|------|---------|
| 1 | - | H-003 | 1580 | [標題] | 🔄 審查中 | 2024-01-27 |
| 2 | ↑1 | H-001 | 1520 | [標題] | ✅ 已驗證 | 2024-01-25 |
| 3 | ↓1 | H-007 | 1450 | [標題] | 📝 草稿 | 2024-01-26 |
| 4 | - | H-005 | 1380 | [標題] | 🔄 審查中 | 2024-01-24 |
| 5 | - | H-002 | 1200 | [標題] | ⏸️ 擱置 | 2024-01-20 |
```

計算 Δ（排名變化）：與上次 STATE.md 比較

### 4. 檢查 Context 提醒

確認是否有需要提醒的資訊：
```
- Domain 設定
- PI 偏好
- 資源限制（數據、時間、計算）
- 即將到來的截止日期
- 風險警示
```

### 5. 生成更新的 STATE.md

```markdown
# Research State

> 最後更新：2024-01-27 15:30
> Session: #12

## 當前位置

- **階段**: Phase 2 - 假說驗證
- **進行中**: H-003 完成 Experimentalist 審查，待 Methodologist
- **下一步**: Methodologist 審查 H-003 → 更新 Elo → 審查 H-007

## 假說排名 (Top 5)

| Rank | Δ | ID | Elo | 標題 | 狀態 |
|------|---|-----|-----|------|------|
| 1 | - | H-003 | 1580 | 高維稀疏迴歸的 minimax rate | 🔄 審查中 |
| 2 | ↑1 | H-001 | 1520 | 自適應估計的收斂速度 | ✅ 已驗證 |
| 3 | ↓1 | H-007 | 1450 | 非參數回歸的最優帶寬 | 📝 草稿 |
| 4 | - | H-005 | 1380 | 變點檢測的漸近性質 | 🔄 審查中 |
| 5 | - | H-002 | 1200 | 因果效應的識別 | ⏸️ 擱置 |

## 關鍵決定

- **2024-01-25** 選擇 diff-in-diff 作為主要方法 - 理由：數據結構適合，文獻支持
- **2024-01-26** 排除 2008 年前數據 - 理由：結構性斷點（金融危機）
- **2024-01-27** H-002 因數據不可得而擱置 - 理由：無法取得個體層級數據

## 待解決問題

- [ ] H-003 的樣本量是否足夠？需要 power analysis
- [ ] 應該用 cluster SE 還是 robust SE？
- [ ] H-007 的理論基礎需要補強

## 下次 Session 應該

1. 完成 H-003 的 Methodologist 審查
2. 更新 Elo 排名（如果通過審查）
3. 開始 H-007 的深度審查（`/review-hypothesis H-007`）

## Context 提醒

- **Domain**: domains/stats-theory/
- **PI 偏好**: 先求理論清晰，再求計算效率
- **資源限制**:
  - 數據：只能用公開數據
  - 時間：3 個月內完成
  - 計算：單機足夠，無需 cluster
- **截止日期**: 2024-04-30 投稿目標

## 最近完成

- **Session #12** (2024-01-27): H-003 Experimentalist 審查，可行性確認
- **Session #11** (2024-01-26): H-007 初稿完成，等待審查
- **Session #10** (2024-01-25): H-001 驗證通過，pass@3 = 95%

## 風險警示

- ⚠️ H-003 和 H-007 的理論可能有重疊，需要釐清
- ⚠️ 4 月截止日期接近，需要加快進度

---

## Session Summary

**Session #12 成果**：
- 完成 H-003 Experimentalist 審查
- 確認假說可行性和數據充分性
- 識別潛在的樣本量問題

**耗時**: 1.5 小時
**工具調用**: 45 次
```

### 6. 保存並確認

Lab Manager：
```
✅ STATE.md 已更新

摘要：
- 假說排名：H-003 保持 #1，H-001 升至 #2
- 新增決定：1 個（擱置 H-002）
- 待解決問題：3 個
- 下次任務：3 個

下次 session 建議從：
📖 讀取 STATE.md 開始，了解當前狀態
```

## 輸出

1. **更新的 STATE.md** - 完整的當前狀態
2. **Session 摘要** - 本次 session 的快速總結

## 自動化特性

Lab Manager 可以從以下自動推斷資訊：
- 工具調用歷史（讀取了哪些文件，執行了哪些命令）
- 時間戳（session 時長）
- 文件變更（新增、修改了哪些文件）
- 假說文件的更新

## 最佳實踐

### 每次更新時
- ✅ 簡潔記錄完成的工作
- ✅ 明確記錄決定和理由
- ✅ 列出具體的下次任務
- ✅ 提醒重要的 context

### 避免
- ❌ 過度詳細（細節在 phase 文件中）
- ❌ 模糊的任務（「繼續分析」太模糊）
- ❌ 忘記更新假說排名
- ❌ 不記錄決定的理由

## 與其他 Commands 的關係

```
任何 command 完成後
        ↓
/update-state    ← 記錄進度
        ↓
[Session 結束]
        ↓
[下次 Session 開始]
        ↓
/progress        ← 查看當前狀態
        ↓
[繼續工作]
```

## 範例場景

### 場景 1: Lab Meeting 結束後

```
User: /update-state

Lab Manager:
讀取 STATE.md... 當前 Session #11
讀取 meeting_notes/2024-01-27.md...

本次 lab meeting：
- 審查了 3 個假說
- H-003 升至 #1（Elo 1450 → 1580）
- 決定暫緩 H-002
- 分配了下週任務

更新 STATE.md：
✅ 假說排名已更新
✅ 關鍵決定已記錄
✅ 下週任務已列出

下次 session 從：
1. `/review-hypothesis H-007`
2. 準備 H-003 的分析腳本
```

### 場景 2: 分析完成後

```
User: 剛完成了 H-001 的主要分析
User: /update-state

Lab Manager:
記錄完成工作... ✅
檢查 results/ 目錄... 發現新文件
檢查 hypotheses/H-001.md... 狀態未變

更新內容：
- 最近完成：H-001 主要分析完成
- 進行中：H-001 待驗證
- 下一步：運行 `/verify-results H-001`

STATE.md 已更新 ✅
```

## 注意事項

- STATE.md 是**摘要**，不是詳細記錄
- 詳細內容在：
  - `meeting_notes/` - 會議詳情
  - `.planning/phases/` - Phase 執行詳情
  - `hypotheses/` - 假說詳情
- STATE.md 用於**快速恢復 context**，不是完整檔案

## 技巧

### 如果忘記更新
沒關係，Lab Manager 可以從文件歷史推斷：
```
Lab Manager:
上次更新是 3 天前，讓我檢查最近的變更...

發現：
- hypotheses/H-005.md 已更新
- meeting_notes/2024-01-26.md 已創建
- results/ 有新文件

讓我幫你更新 STATE.md...
```

### 頻率建議
- 理想：每次 session 結束
- 最低：每週一次
- 重要時刻：Phase 轉換、關鍵決定後
